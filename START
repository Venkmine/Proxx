#!/usr/bin/env bash
# ==============================================================================
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
# â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•    â–ˆâ–ˆâ•”â•â•â•â•â•â•šâ•â•â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â–ˆâ–ˆâ•”â•â•â•
# â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ•”â•  â•šâ–ˆâ–ˆâ–ˆâ•”â•     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   
# â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—  â–ˆâ–ˆâ•”â–ˆâ–ˆâ•—     â•šâ•â•â•â•â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•‘   
# â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â• â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘   
# â•šâ•â•     â•šâ•â•  â•šâ•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•    â•šâ•â•â•â•â•â•â•   â•šâ•â•   â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•   â•šâ•â•   
# ==============================================================================
# ðŸš€ PROXX DEVELOPMENT LAUNCHER â€” MODE-BASED
# ==============================================================================
#
# Usage from project root:
#   ./start web       â†’ Web app only (Vite + browser)
#   ./start electron  â†’ Electron app only (NO Vite, file://dist)
#   ./start qc        â†’ QC mode (E2E_TEST=true, NO Vite)
#
# This script supports three explicit launch modes:
#
# WEB MODE:
#   - Starts backend (uvicorn)
#   - Starts Vite dev server
#   - Opens browser to http://127.0.0.1:5173
#   - NO Electron launch
#
# ELECTRON MODE:
#   - Starts backend (uvicorn)
#   - NO Vite (must build dist first)
#   - Launches Electron loading file://dist/index.html
#   - Electron uses built/bundled assets only
#
# QC MODE:
#   - Starts backend (uvicorn)
#   - Sets E2E_TEST=true environment
#   - NO Vite
#   - Launches Electron for QC/testing
#
# Logs are written to /tmp/proxx_*.log
# Press Ctrl+C to stop all services gracefully
#
# ==============================================================================

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
NC='\033[0m' # No Color

# Get absolute path to project root (where this script lives)
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKEND_DIR="${PROJECT_ROOT}/backend"
FRONTEND_DIR="${PROJECT_ROOT}/frontend"
VENV_PYTHON="${PROJECT_ROOT}/.venv/bin/python3"

# Configuration
BACKEND_PORT=8085
VITE_PORT=5173
BACKEND_URL="http://127.0.0.1:${BACKEND_PORT}"
VITE_URL="http://127.0.0.1:${VITE_PORT}"

# Log files
BACKEND_LOG="/tmp/proxx_backend.log"
VITE_LOG="/tmp/proxx_vite.log"

# Parse launch mode
LAUNCH_MODE="${1:-electron}"  # Default to electron if no arg

# Validate mode
if [[ ! "${LAUNCH_MODE}" =~ ^(web|electron|qc)$ ]]; then
  echo -e "${RED}ERROR:${NC} Invalid launch mode: ${LAUNCH_MODE}"
  echo ""
  echo "Usage: ./start [mode]"
  echo ""
  echo "Available modes:"
  echo "  web       - Web app only (Vite + browser, NO Electron)"
  echo "  electron  - Electron app only (NO Vite, file://dist)"
  echo "  qc        - QC/testing mode (E2E_TEST=true, NO Vite)"
  echo ""
  exit 1
fi

# Print with timestamp
log() {
  echo -e "${CYAN}[$(date +%H:%M:%S)]${NC} $1"
}

error() {
  echo -e "${RED}[ERROR]${NC} $1"
}

success() {
  echo -e "${GREEN}âœ“${NC} $1"
}

warning() {
  echo -e "${YELLOW}âš ${NC} $1"
}

# ==============================================================================
# STEP 0: Pre-flight checks
# ==============================================================================

# Print mode banner
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
case "${LAUNCH_MODE}" in
  web)
    echo -e "${MAGENTA}ðŸŒ PROXX WEB MODE${NC}"
    echo "   Backend + Vite + Browser (NO Electron)"
    ;;
  electron)
    echo -e "${MAGENTA}ðŸ–¥ï¸  PROXX ELECTRON MODE${NC}"
    echo "   Backend + Electron (NO Vite, file://dist only)"
    ;;
  qc)
    echo -e "${MAGENTA}ðŸ§ª PROXX QC MODE${NC}"
    echo "   Backend + Electron (E2E_TEST=true, NO Vite)"
    ;;
esac
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Check if venv exists
if [ ! -f "${VENV_PYTHON}" ]; then
  error "Python virtual environment not found at ${VENV_PYTHON}"
  error "Please run: python3 -m venv ${PROJECT_ROOT}/.venv && source ${PROJECT_ROOT}/.venv/bin/activate && pip install -r ${BACKEND_DIR}/requirements.txt"
  exit 1
fi

# Check if pnpm is available
if ! command -v pnpm &> /dev/null; then
  error "pnpm is not installed"
  error "Please install: npm install -g pnpm"
  exit 1
fi

# Check if frontend dependencies are installed
if [ ! -d "${FRONTEND_DIR}/node_modules" ]; then
  warning "Frontend dependencies not installed"
  log "Installing frontend dependencies..."
  cd "${FRONTEND_DIR}"
  pnpm install
  success "Dependencies installed"
fi

# ==============================================================================
# STEP 1: Clean up existing processes
# ==============================================================================
echo ""
log "Cleaning up existing processes..."

# Kill processes by pattern
pkill -9 -f "uvicorn app.main:app" 2>/dev/null || true
pkill -9 -f "vite" 2>/dev/null || true
pkill -9 -f "electron dist-electron/main.mjs" 2>/dev/null || true

# Kill processes by port
for port in ${BACKEND_PORT} ${VITE_PORT}; do
  lsof -ti :${port} 2>/dev/null | xargs kill -9 2>/dev/null || true
done

sleep 2
success "Cleanup complete"

# ==============================================================================
# STEP 2: Start Backend (uvicorn)
# ==============================================================================
echo ""
log "Starting backend on ${BACKEND_URL}..."

cd "${BACKEND_DIR}"
PYTHONPATH="${BACKEND_DIR}" "${VENV_PYTHON}" -m uvicorn app.main:app \
  --reload \
  --host 127.0.0.1 \
  --port ${BACKEND_PORT} \
  > "${BACKEND_LOG}" 2>&1 &

BACKEND_PID=$!
echo "  PID: ${BACKEND_PID}"
echo "  Log: ${BACKEND_LOG}"

# Wait for backend health check
log "Waiting for backend health..."
for i in {1..30}; do
  if curl -sf "${BACKEND_URL}/health" > /dev/null 2>&1; then
    success "Backend is healthy"
    break
  fi
  
  if [ $i -eq 30 ]; then
    error "Backend failed to start within 30 seconds"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Last 50 lines of backend log:"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    tail -50 "${BACKEND_LOG}" 2>/dev/null || echo "(log file empty or not found)"
    exit 1
  fi
  
  sleep 1
done

# ==============================================================================
# STEP 3: Start Vite Dev Server (web mode only)
# ==============================================================================

if [ "${LAUNCH_MODE}" = "web" ]; then
  echo ""
  log "Starting Vite dev server on ${VITE_URL}..."

  cd "${FRONTEND_DIR}"
  pnpm dev > "${VITE_LOG}" 2>&1 &
  VITE_PID=$!
  echo "  PID: ${VITE_PID}"
  echo "  Log: ${VITE_LOG}"

  # Wait for Vite to be ready
  log "Waiting for Vite to be ready..."
  for i in {1..30}; do
    if curl -sf "${VITE_URL}" > /dev/null 2>&1; then
      success "Vite is ready"
      break
    fi
    
    if [ $i -eq 30 ]; then
      error "Vite failed to start within 30 seconds"
      echo ""
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "Last 50 lines of Vite log:"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      tail -50 "${VITE_LOG}" 2>/dev/null || echo "(log file empty or not found)"
      exit 1
    fi
    
    sleep 1
  done
else
  VITE_PID=""
  echo ""
  log "Skipping Vite (${LAUNCH_MODE} mode uses dist/ only)"
fi

# ==============================================================================
# STEP 4: Build frontend dist and Electron (electron/qc modes only)
# ==============================================================================

if [ "${LAUNCH_MODE}" != "web" ]; then
  echo ""
  log "Checking frontend dist build..."
  
  cd "${FRONTEND_DIR}"
  
  # Check if dist exists and is reasonably recent
  if [ ! -d "dist" ] || [ ! -f "dist/index.html" ]; then
    warning "Frontend dist not found, building now..."
    pnpm run build
    success "Frontend build complete"
  else
    # Check if TypeScript sources are newer than dist (macOS stat syntax)
    if [ "$(find src -type f -name '*.tsx' -o -name '*.ts' 2>/dev/null | xargs stat -f %m 2>/dev/null | sort -n | tail -1)" -gt "$(stat -f %m dist/index.html 2>/dev/null || echo 0)" ]; then
      warning "Frontend sources changed, rebuilding..."
      pnpm run build
      success "Frontend build complete"
    else
      success "Frontend dist is up to date"
    fi
  fi
  
  echo ""
  log "Checking Electron build..."

  # Check if Electron builds exist
  if [ ! -f "dist-electron/main.mjs" ] || [ ! -f "dist-electron/preload.mjs" ]; then
    warning "Electron builds not found, building now..."
    pnpm run electron:build
    success "Electron build complete"
  else
    # Check if TypeScript sources are newer than builds (macOS stat syntax)
    if [ "$(stat -f %m electron/main.ts 2>/dev/null || echo 0)" -gt "$(stat -f %m dist-electron/main.mjs 2>/dev/null || echo 0)" ]; then
      warning "Electron sources changed, rebuilding..."
      pnpm run electron:build
      success "Electron build complete"
    else
      success "Electron builds are up to date"
    fi
  fi
else
  echo ""
  log "Skipping dist build (web mode uses Vite dev server)"
fi

# ==============================================================================
# STEP 5: Launch application based on mode
# ==============================================================================
echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
success "${GREEN}All services ready!${NC}"
echo ""
echo "   ${CYAN}Backend:${NC}  ${BACKEND_URL}"

if [ "${LAUNCH_MODE}" = "web" ]; then
  echo "   ${CYAN}Vite:${NC}     ${VITE_URL}"
  echo "   ${CYAN}Mode:${NC}     Web app (opening browser...)"
elif [ "${LAUNCH_MODE}" = "electron" ]; then
  echo "   ${CYAN}Mode:${NC}     Electron (file://dist/index.html)"
elif [ "${LAUNCH_MODE}" = "qc" ]; then
  echo "   ${CYAN}Mode:${NC}     QC/Testing (E2E_TEST=true)"
fi

echo ""
echo "   ${CYAN}Logs:${NC}"
echo "   - Backend: tail -f ${BACKEND_LOG}"
if [ "${LAUNCH_MODE}" = "web" ]; then
  echo "   - Vite:    tail -f ${VITE_LOG}"
fi
echo ""
echo "   ${YELLOW}Press Ctrl+C to stop all services${NC}"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""

# Setup cleanup trap
cleanup() {
  echo ""
  log "Shutting down services..."
  kill ${BACKEND_PID} 2>/dev/null || true
  if [ -n "${VITE_PID}" ]; then
    kill ${VITE_PID} 2>/dev/null || true
  fi
  pkill -9 -f "electron dist-electron/main.js" 2>/dev/null || true
  sleep 1
  success "All services stopped"
  exit 0
}
trap cleanup INT TERM

# Launch based on mode
if [ "${LAUNCH_MODE}" = "web" ]; then
  # Web mode: Open browser and wait
  sleep 1
  if command -v open &> /dev/null; then
    open "${VITE_URL}"
  elif command -v xdg-open &> /dev/null; then
    xdg-open "${VITE_URL}"
  else
    log "Browser auto-open not supported, please open ${VITE_URL} manually"
  fi
  
  log "Web app running. Press Ctrl+C to stop."
  
  # Wait for interrupt
  wait
  
elif [ "${LAUNCH_MODE}" = "electron" ]; then
  # Electron mode: Launch Electron with dist (NO Vite)
  sleep 1
  cd "${FRONTEND_DIR}"
  
  # CRITICAL: Do NOT set VITE_DEV_SERVER_URL
  # Electron will load file://dist/index.html
  npx electron dist-electron/main.js
  
elif [ "${LAUNCH_MODE}" = "qc" ]; then
  # QC mode: Launch Electron with E2E_TEST flag
  sleep 1
  cd "${FRONTEND_DIR}"
  
  # Set QC environment variables
  export E2E_TEST=1
  export E2E_AUDIT_MODE=0
  
  # CRITICAL: Do NOT set VITE_DEV_SERVER_URL
  # Electron will load file://dist/index.html
  npx electron dist-electron/main.js
fi

# If Electron exits normally, cleanup
cleanup
